<!-- Created using vQmod XML Generator by UKSB - http://uksb.github.com/vqgen/ //-->
<modification>
	<id><![CDATA[iURL 2 Image]]></id>
	<version><![CDATA[1.1]]></version>
	<vqmver><![CDATA[2.3]]></vqmver>
	<author><![CDATA[Jan Oman, http://inteh.si]]></author>
	<file name="catalog/model/tool/image.php">
		<operation>
			<search position="after"><![CDATA[if (!file_exists(DIR_IMAGE . $filename) || !is_file(DIR_IMAGE . $filename)) {]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[try {
			
			if($filename == NULL || $filename == '' || !filter_var($filename, FILTER_VALIDATE_URL))	{
				return;
			}
			
			$old_image = $filename;
			$info = pathinfo($filename);
			
			if(!isset($info['extension']))
				return;
			
			$extension = $info['extension'];
			$filename = 'data/'. basename($old_image);
			$new_image =  utf8_substr($filename, 0, utf8_strrpos($filename, '.')) .'.' . $extension;
			
			$img = DIR_IMAGE . $new_image;
			
			$ch = curl_init($old_image);
			//curl_setopt($ch, CURLOPT_NOBODY, true);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			$data = curl_exec($ch);
			$retcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
			curl_close($ch);
			if($retcode < 199 || $retcode  > 300) {
				throw new Exception("The url does not exsist: " . $old_image . " Return code : " .$retcode );
				return;
			}
			file_put_contents($img, $data);


			$this->db->query("START TRANSACTION;\n");
			$this->db->query("UPDATE `".DB_PREFIX."product` SET `image` = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE `".DB_PREFIX."product_image` SET `image` = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE " . DB_PREFIX . "category SET image = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE " . DB_PREFIX . "manufacturer SET image = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			
			if (!file_exists(DIR_IMAGE . $new_image) || !is_file(DIR_IMAGE . $new_image)) {
				$this->db->query("ROLLBACK;");
				return;
			}

			} catch (Exception $e) {
				$errstr = $e->getMessage();
				$errline = $e->getLine();
				$errfile = $e->getFile();
				$errno = $e->getCode();
				if ($this->config->get('config_error_log')) {
					$this->log->write('PHP iURL 2 IMG - A problem occurred with the image : ' . $old_image . ' MSG : '  . get_class($e) . ':  ' . $errstr . ' in ' . $errfile . ' on line ' . $errline );
				}
				$this->db->query("ROLLBACK;");
				return FALSE;
			}]]></add>
		</operation>
	</file>
	<file name="admin/model/tool/image.php">
		<operation>
			<search position="after"><![CDATA[if (!file_exists(DIR_IMAGE . $filename) || !is_file(DIR_IMAGE . $filename)) {]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[try {
			
			if($filename == NULL || $filename == '' || !filter_var($filename, FILTER_VALIDATE_URL))	{
				return;
			}
			
			$old_image = $filename;
			$info = pathinfo($filename);
			
			if(!isset($info['extension']))
				return;
			
			$extension = $info['extension'];
			$filename = 'data/'. basename($old_image);
			$new_image =  utf8_substr($filename, 0, utf8_strrpos($filename, '.')) .'.' . $extension;
			
			$img = DIR_IMAGE . $new_image;
			
			$ch = curl_init($old_image);
			//curl_setopt($ch, CURLOPT_NOBODY, true);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			$data = curl_exec($ch);
			$retcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
			curl_close($ch);
			if($retcode < 199 || $retcode  > 300) {
				throw new Exception("The url does not exsist: " . $old_image . " Return code : " .$retcode );
				return;
			}
			file_put_contents($img, $data);


			$this->db->query("START TRANSACTION;\n");
			$this->db->query("UPDATE `".DB_PREFIX."product` SET `image` = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE `".DB_PREFIX."product_image` SET `image` = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE " . DB_PREFIX . "category SET image = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			$this->db->query("UPDATE " . DB_PREFIX . "manufacturer SET image = '" . $this->db->escape(html_entity_decode($new_image, ENT_QUOTES, 'UTF-8')) . "' WHERE `image` = '" . $old_image . "'");
			
			if (!file_exists(DIR_IMAGE . $new_image) || !is_file(DIR_IMAGE . $new_image)) {
				$this->db->query("ROLLBACK;");
				return;
			}

			} catch (Exception $e) {
				$errstr = $e->getMessage();
				$errline = $e->getLine();
				$errfile = $e->getFile();
				$errno = $e->getCode();
				if ($this->config->get('config_error_log')) {
					$this->log->write('PHP iURL 2 IMG - A problem occurred with the image : ' . $old_image . ' MSG : '  . get_class($e) . ':  ' . $errstr . ' in ' . $errfile . ' on line ' . $errline );
				}
				$this->db->query("ROLLBACK;");
				return FALSE;
			}]]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/category.php">
		<operation>
			<search position="before"><![CDATA[if (isset($data['image'])) {]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[
			if (isset($data['image_url']) && trim($data['image_url']) != "" ){
			$this->load->model('tool/image'); 
			$this->db->query("UPDATE " . DB_PREFIX . "category SET image = '" . $this->db->escape(html_entity_decode($data['image_url'], ENT_QUOTES, 'UTF-8')) . "' WHERE category_id = '" . (int)$category_id . "'");
			$this->model_tool_image->resize($data['image_url'], 100, 100);	
		} else 
		]]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/manufacturer.php">
		<operation>
			<search position="before"><![CDATA[if (isset($data['image'])) {]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[
			if (isset($data['image_url']) && trim($data['image_url']) != "" ){
			$this->load->model('tool/image'); 
			$this->db->query("UPDATE " . DB_PREFIX . "manufacturer SET image = '" . $this->db->escape(html_entity_decode($data['image_url'], ENT_QUOTES, 'UTF-8')) . "' WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");
			$this->model_tool_image->resize($data['image_url'], 100, 100);	
		} else 	]]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/product.php">
		<operation>
			<search position="before"><![CDATA[if (isset($data['image'])) {]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[if (isset($data['image_url']) && trim($data['image_url']) != "") {
			$this->load->model('tool/image'); 
			$this->db->query("UPDATE " . DB_PREFIX . "product SET image = '" . $this->db->escape(html_entity_decode($data['image_url'], ENT_QUOTES, 'UTF-8')) . "' WHERE product_id = '" . (int)$product_id . "'");
			$this->model_tool_image->resize($data['image_url'], 100, 100);	
		} else  ]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_image SET product_id = '" . (int)$product_id . "', image = '" . $this->db->escape(html_entity_decode($product_image['image'], ENT_QUOTES, 'UTF-8')) . "', sort_order = '" . (int)$product_image['sort_order'] . "'");]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[if (isset($product_image['image_url']) && trim($product_image['image_url']) != "") {
					$this->load->model('tool/image'); 
					$this->db->query("INSERT INTO " . DB_PREFIX . "product_image SET product_id = '" . (int)$product_id . "', image = '" . $this->db->escape(html_entity_decode($product_image['image_url'], ENT_QUOTES, 'UTF-8')) . "', sort_order = '" . (int)$product_image['sort_order'] . "'");
					$this->model_tool_image->resize($product_image['image_url'], 100, 100);	
				} else {
					$this->db->query("INSERT INTO " . DB_PREFIX . "product_image SET product_id = '" . (int)$product_id . "', image = '" . $this->db->escape(html_entity_decode($product_image['image'], ENT_QUOTES, 'UTF-8')) . "', sort_order = '" . (int)$product_image['sort_order'] . "'");
				}  ]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/category_form.tpl">
		<operation>
			<search position="replace"><![CDATA[<a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');"><?php echo $text_clear; ?></a></div></td>]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[<a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');$('#image_url').val('');"><?php echo $text_clear; ?></a></div><br>Url: <input type="text" name="image_url" value="<?php echo $image; ?>" id="image_url" /></td>]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$('#' + thumb).replaceWith('<img src="' + data + '" alt="" id="' + thumb + '" />');]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[$('#image_url').val('');]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/manufacturer_form.tpl">
		<operation>
			<search position="replace"><![CDATA[<br /><a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');"><?php echo $text_clear; ?></a></div></td>]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[<br /><a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');$('#image_url').val('');"><?php echo $text_clear; ?></a></div><br>Url: <input type="text" name="image_url" value="<?php echo $image; ?>" id="image_url" /></td>]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$('#' + thumb).replaceWith('<img src="' + data + '" alt="" id="' + thumb + '" />');]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[$('#image_url').val('');]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="replace"><![CDATA[<a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');"><?php echo $text_clear; ?></a></div></td>]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[<a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');$('#image_url').val('');"><?php echo $text_clear; ?></a></div><br>Url: <input type="text" name="image_url" value="<?php echo $image; ?>" id="image_url" /></td>]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[<a onclick="image_upload('image<?php echo $image_row; ?>', 'thumb<?php echo $image_row; ?>');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb<?php echo $image_row; ?>').attr('src', '<?php echo $no_image; ?>'); $('#image<?php echo $image_row; ?>').attr('value', '');"><?php echo $text_clear; ?></a></div></td>]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[<a onclick="image_upload('image<?php echo $image_row; ?>', 'thumb<?php echo $image_row; ?>');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb<?php echo $image_row; ?>').attr('src', '<?php echo $no_image; ?>'); $('#image<?php echo $image_row; ?>').attr('value', '');$('#image_url<?php echo $image_row; ?>').val('');"><?php echo $text_clear; ?></a></div><br> Url image: <input type="text" name="product_image[<?php echo $image_row; ?>][image_url]" value="<?php echo $product_image['image']; ?>" id="image_url<?php echo $image_row; ?>" /></td>]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	html += '    <td class="left"><div class="image"><img src="<?php echo $no_image; ?>" alt="" id="thumb' + image_row + '" /><input type="hidden" name="product_image[' + image_row + '][image]" value="" id="image' + image_row + '" /><br /><a onclick="image_upload(\'image' + image_row + '\', \'thumb' + image_row + '\');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$(\'#thumb' + image_row + '\').attr(\'src\', \'<?php echo $no_image; ?>\'); $(\'#image' + image_row + '\').attr(\'value\', \'\');"><?php echo $text_clear; ?></a></div></td>';]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[	html += '    <td class="left"><div class="image"><img src="<?php echo $no_image; ?>" alt="" id="thumb' + image_row + '" /><input type="hidden" name="product_image[' + image_row + '][image]" value="" id="image' + image_row + '" /><br /><a onclick="image_upload(\'image' + image_row + '\', \'thumb' + image_row + '\');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$(\'#thumb' + image_row + '\').attr(\'src\', \'<?php echo $no_image; ?>\'); $(\'#image' + image_row + '\').attr(\'value\', \'\');$(\'#image_url'+image_row + '\').val(\'\');"><?php echo $text_clear; ?></a></div><br>Url: <input type="text" name="product_image[' + image_row + '][image_url]" value="" id="image_url' + image_row + '" /></td>';]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$('#' + thumb).replaceWith('<img src="' + text + '" alt="" id="' + thumb + '" />');]]></search>
			<ignoreif><![CDATA[True]]></ignoreif>
			<add><![CDATA[if(thumb.indexOf('thumb') >= 0)	{
							id = thumb.replace('thumb','');
							$('#image_url'+id).val('');
						} else
							$('#image_url').val('');]]></add>
		</operation>
	</file>
</modification>