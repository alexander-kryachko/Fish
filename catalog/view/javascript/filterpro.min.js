var fIID = 0;
var interval = 1;
var $cookie = function(){};
var container = ".product-{view}";
var redirect = false;
var hide_options = false;
var hide_count = false;
var disable_mask = false;
var window_hash = false;
var filter_hash = "";
var endless_scroller = false;
var noajax = false;
var fsearch = false;
var filter_onload = false;
var filer_selected = false;
var history_hash = "";
jQuery.fn.exists = function(){return this.length > 0}
/**
 * fixs for IE
 */
if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(obj, start) {
        for (var i = (start || 0), j = this.length; i < j; i++) {
            if (this[i] === obj) {
                return i;
            }
        }
        return -1;
    }
}

function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}

String.prototype.hashCode = function(){
    var hash = 0, i, ch;
    if (this.length == 0) return hash;
    for (i = 0; i < this.length; i++) {
        ch = this.charCodeAt(i);
        hash = ((hash<<5)-hash)+ch;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
};
$(function() {
    if ($.fn.jScrollPane != undefined)
        $('.collapsible:not(.price_slider)').jScrollPane();
});
(function($){
    $.fn.extend({hideOptions: function() {
        var s = this;
        return s.each(function(i,e) {
            var d = $.data(e, 'disabledOptions') || [];
            $(e).find("option[disabled=\"disabled\"]").each(function() {
                d.push($(this).detach());
            });
            $.data(e, 'disabledOptions', d);
        });
    }, showOptions: function() {
        var s = this;
        return s.each(function(i,e) {
            var d = $.data(e, 'disabledOptions') || [];
            for (var i in d) {
                $(e).append(d[i]);
            }
        });
    }});
})(jQuery);
var tag_tmpl = $.template(null, '<tr><td><input id="tag_${tag}" class="filtered" type="checkbox" name="tags[]" value="${tag}" {{if checked}} checked="checked" {{/if}}>' +
    '<label for="tag_${tag}"></label><label for="tag_${tag}">${name}</label></td></tr>');
var cat_tmpl = $.template(null, '<tr><td><input id="cat_${category_id}" class="filtered" type="checkbox" name="categories[]" value="${category_id}" {{if checked}} checked="checked" {{/if}}>'+
    ' <label for="cat_${category_id}"></label><label for="cat_${category_id}"><span class="label-name">${name}</span><span class="label-value">${total}</span></label></td></tr>');
$(document).on("change", ".price_limit", (function () {
    var b = parseInt($("#min_price").val());
    var a = parseInt($("#max_price").val());
    $("#slider-range").slider("values", [b, a]);
    iF(1)
}));
function synchronizeImgCheckboxes() {
    $("#filterpro input.filtered[type=\"checkbox\"]").each(function() {
        var $img = $(this).next('img');
        if ($img.exists()) {
            if ($(this).is(":checked")) {
                $img.addClass("selected");
            } else {
                $img.removeClass("selected");
            }
        }
    });
}
$(document).on("change", "#filterpro .filtered", function () {
    iF(1);
});

$(document).on("click", "#filterpro .filtered[type=\"radio\"]", function () {
    if (this.previous) {
        this.checked = false;
        $(this).trigger('change');
    }

    $("#filterpro .filtered[name=\""+$(this).attr("name")+"\"]").each(function(i,e){
        this.previous = this.checked;
    });
});

$(function () {
    $("#slider-range").slider({range:true, min:0, max:0, values:[0, 0], stop:function (a, b) {
        iF(1)
    }, slide:function (a, b) {
        $("#min_price").val(b.values[0]);
        $("#max_price").val(b.values[1])
    }});
});
function iF(getTotals) {

    clearTimeout(fIID);
    if (redirect) {
        var a = $("#filterpro").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
        if(window_hash) {
            location.href = redirect + "#" + a;
        } else {
            noAjaxFilter();
        }
        return;
    }
    $("#filterpro_page").val(1);
    var $e = $('.pagination a, .pagination b').first();
    var url = $e.attr("href") && $e.attr("href").substr($e[0].baseURI.length - 1) || undefined;
    current_page = 1;
    fIID = setTimeout(function () {
        doFilter(false, getTotals, false, url)
    }, interval);
}

function success(g, b, append, pushUrl) {
    var cont = getCont();
    if (!window_hash && pushUrl && window.history.pushState) {
        window.history.pushState({"g": g}, null, pushUrl);
    }
    if (g.result_html) {
        if(g.result_html.list && g.result_html.grid) {
            if (append) {
                $(".product-list").append(g.result_html.list);
                $(".product-grid").append(g.result_html.grid);
            } else {
                $(".product-list").empty();
                $(".product-grid").empty();
                $(".product-list").html(g.result_html.list);
                $(".product-grid").html(g.result_html.grid);
            }
        } else {
            if (append) {
                $(cont).append(g.result_html);
            } else {
                $(cont).empty();
                $(cont).html(g.result_html);
            }
        }
        if (typeof(display) != "undefined") {
            if ($cookie) { var view = $cookie("display"); }
            if (!view) { view = "grid"; }
            display(view ? view : "grid");
        }
        if (typeof($.fn.lazyload) != "undefined") {
            $("img.lazy").lazyload({
                skip_invisible : false
            });
        }
        afterload();
    }
    if (g.pagination){
        $(".pagination").html(g.pagination);
    }
    if (endless_scroller && $('.pagination div.links b').next('a').length == 0) {
        $('#showmore').hide();
    } else{
        $('#showmore').show();
    }

    if (hide_options) {
        $("#filterpro select.filtered").showOptions();
    }

    if (g.totals_data) {
        product_total = g.totals_data.product_total;
        if (g.totals_data.tags.length) {
            $('#filter_tags').html('');
            $.tmpl(tag_tmpl, g.totals_data.tags).appendTo('#filter_tags');
            $('#filter_tags').parents('.option_box').show();
        } else {
            $('#filter_tags').parents('.option_box').hide();
        }

        /*$('#filter_categories').html('');
        if (g.totals_data.categories.length) {
            console.log(g.totals_data.categories);
            $.tmpl(cat_tmpl, g.totals_data.categories).appendTo('#filter_categories');
            $('#filter_categories').parents('.option_box').show();
        } else {
            $('#filter_categories').parents('.option_box').hide();
        }*/
        var atts = {};
        $.each(g.totals_data.attributes, function(k, v) {
            atts[(v.id + "_" + v.text).replace(/\s/g, '_')] = v.t;
        });

        $('.a_name').each(function (k, v) {
            var at_v_i = $(v).attr('at_v_i').replace(/\s/g, '_');
            var at_v_i_e = escapeHtml(at_v_i);
            if (atts[at_v_i]) {
                if(v.tagName == "OPTION"){
                    $('[at_v_t="' + at_v_i_e + '"]').html($('[at_v_t="' + at_v_i_e + '"]').attr('data-value'));
                } else {
                    $('[at_v_t="' + at_v_i_e + '"]').html("<span class='label-name'>" + $('[at_v_t="' + at_v_i_e + '"]').attr('data-value') +"</span>"+ (hide_count ? "" : " <span class='label-value'>" + atts[at_v_i] + "</span>"));
                }
                $(v).removeAttr("disabled");
                if(hide_options && v.tagName != "OPTION"){
                    $(v).parent().parent().show();
                }
            } else {
                $('[at_v_t="' + at_v_i_e + '"]').text($('[at_v_t="' + at_v_i_e + '"]').attr('data-value'));
                $(v).attr("disabled", "disabled");
                if(hide_options && v.tagName != "OPTION")
                    $(v).parent().parent().hide();
                $(v).prop('checked', false);
                $(v).prop('selected', false);
            }
        });

        var h = [];
        $.each(g.totals_data.manufacturers, function (f, k) {
            if (k.id) {
                h[h.length] = k.id;
                var j = $("#manufacturer_" + k.id);
                if (j.length == 0) {
                    return;
                }
                j.removeAttr("disabled");
                if(hide_options && j[0].tagName != "OPTION")
                    j.parent().parent().show();
                if (j.get(0).tagName == "OPTION") {
                    j.text($("#m_" + k.id).val() + (hide_count ? "" : " (" + k.t + ")"))
                } else {
                    $('label[for="manufacturer_' + k.id + '"]:eq(1)').html("<span class='label-name'>" + $("#m_" + k.id).val()+"</span>" + (hide_count ? "" : " <span class='label-value'>" + k.t + "</span>"))
                }
            }
        });
        $(".manufacturer_value").each(function (f, k) {
            var j = $(this);
            var l = j.attr("id").match(/manufacturer_(\d+)/);
            if ($.inArray(l[1], h) < 0) {
                j.attr("disabled", "disabled");
                if(hide_options && j[0].tagName != "OPTION")
                    j.parent().parent().hide();
                if (this.tagName == "OPTION") {
                    j.text($("#m_" + l[1]).val());
                    j.prop("selected", false)
                } else {
                    $('label[for="manufacturer_' + l[1] + '"]:eq(1)').text($("#m_" + l[1]).val());
                    j.prop("checked", false)
                }
            }
        });
        var e = [];
        $.each(g.totals_data.options, function (j, k) {
            if (k.id) {
                e[e.length] = k.id;
                var f = $("#option_value_" + k.id);
                if (f.exists()) {
                    f.removeAttr("disabled");
                    if(hide_options && f[0].tagName != "OPTION")
                        f.parent().parent().show();
                    if (f.get(0).tagName == "OPTION") {
                        f.text($("#o_" + k.id).val() + (hide_count ? "" : " (" + k.t + ")"))
                    } else {
                        $('label[for="option_value_' + k.id + '"]:eq(1)').html("<span class='label-name'>" + $("#o_" + k.id).val() + "</span>" + (hide_count ? "" : " <span class='label-value'>" + k.t + "</span>"))
                    }
                }
            }
        });
        $(".option_value").each(function (j, k) {
            var f = $(this);
            var l = f.attr("id").match(/option_value_(\d+)/);
            if ($.inArray(l[1], e) < 0) {
                f.attr("disabled", "disabled");
                if(hide_options && f[0].tagName != "OPTION")
                    f.parent().parent().hide();
                if (this.tagName == "OPTION") {
                    f.text($("#o_" + l[1]).val());
                    f.prop("selected", false)
                } else {
                    $('label[for="option_value_' + l[1] + '"]:eq(1)').text($("#o_" + l[1]).val());
                    f.prop("checked", false)
                }
            }
        });

        $('#filterpro ul.box-filter ul.collapsible li span.label-value').text('');
        e = [];
        $.each(g.totals_data.filters, function (j, k) {
            if (k.id) {
                e[e.length] = k.id;
                if (!hide_count) {
                    $('#filter' + k.id).parent().find('span.label-value').text(k.t)
                }
            }
        });

        $('#filterpro ul.box-filter .filtered, #filterpro .filter_box option').removeAttr("disabled");
        $('#filterpro ul.box-filter li ul.collapsible li').show();
        $('#filterpro ul.box-filter .filtered').each(function(j, k) {
            var f = $(this);
            var l = f.attr("id").match(/filter(\d+)/);
            if ($.inArray(l[1], e) < 0) {
                f.prop("checked", false);
                f.attr("disabled", "disabled");
                if(hide_options) {
                    f.parent().hide();
                }
            }
        });
        $('#filterpro div.filter_box div.collapsible select.filtered option').each(function(j, k){
            f = $(this);
            if (f.val() != '' && $.inArray(f.val(), e) < 0) {
                f.prop("selected", false);
                f.attr("disabled", "disabled");
            }
        });

        if(hide_options) {
            $("#filterpro select.filtered").hideOptions();
        }
        if (filer_selected) {
            $('#checklist').html('');
            h = '<div class="option_box">' +
                '<div class="option_name">Выбранные фильтры</div>' +
                '<div class="collapsible">';
            var show = false;
            $('.option_box').has('input[type=checkbox]:checked').each(function (i, e) {
                var $box = $(e);
//                h += '<div class="head">' + $box.find('.option_name').text() + '</div>';

                $box.find('input[type=checkbox]:checked').each(function (i, e) {
                    $input = $(e);
                    h += '<div class="value"><span class="text">' + $('label[for=' + $input.attr('id') + ']').text() + '</span><span class="close" data-for="' + $input.attr('id') + '"> x</span></div>';
                    show = true;
                });
            });
            h +='</div></div>';
            if (show){
                $('#checklist').append(h);
            }

            $('#checklist .close').click(function () {
                var id = $(this).attr('data-for');
                $('#' + id).click();
            });
        }
    }
}
function getCont(){
	return ".product-list";
    if ($cookie){
        var view = $cookie("display");
    }
    if (!view) {view = "grid";}
    var cont = container.replace('{view}', view);
    if (!$(cont).exists()){
        cont = container.replace('{view}', 'grid');
    }
    return cont;
}
var cache = [];
function doFilter(getPrice, getTotals, append, pushUrl) {
    var a = $("#filterpro").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
    if (!getPrice) {
        window_hash && (history_hash = a) && (window.location.hash = a) || (filter_hash = a);
    }
    var h = a.hashCode();
    if (cache[h]){
        success(cache[h], getPrice, append, pushUrl);
    } else {
        var cont = getCont();
        if(!disable_mask) {
            if(!noajax) {
                $(cont).loadmask();
            }
            $(".filterpro").loadmask();
        }

        var searchData = '';
        if(fsearch){
            var search = $('#content input[name=\'search\']').attr('value');
            if (search) {
                searchData += '&search=' + encodeURIComponent(search);
            }
            var category_id = $('#content select[name=\'category_id\']').attr('value');
            if (category_id > 0) {
                searchData += '&category_id=' + encodeURIComponent(category_id);
            }
            var sub_category = $('#content input[name=\'sub_category\']:checked').attr('value');
            if (sub_category) {
                searchData += '&sub_category=true';
            }
            var filter_description = $('#content input[name=\'description\']:checked').attr('value');
            if (filter_description) {
                searchData += '&description=true';
            }
        }
        var data = a + (getPrice ? "&getPriceLimits=true" : "") + (getTotals ? "&getTotals=1" : "")+searchData;
        $.ajax({url:"index.php?route=module/filterpro/getproducts", type:"POST", data:data, dataType:"json",
            success:function (g) {
                success(g, getPrice, append, pushUrl);
                var a = $("#filterpro").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
                var h = a.hashCode();
                cache[h] = g;
                var cont = getCont();
                if(!disable_mask) {
                    if(!noajax) {
                        $(cont).loadunmask();
                    }
                    $(".filterpro").loadunmask();
                }
            },
            error:function(jqXHR, textStatus, errorThrown) {
                var cont = getCont();
                if(!noajax) {
                    $(cont).loadunmask();
                }
                $(".filterpro").loadunmask();
            }
        });
    }
}

function initfilter(options){
    container = options.container;
    redirect = options.filter_redirect;
    hide_options = options.hide_options;
//    hide_count = options.hide_count;
    disable_mask = options.disable_mask;
    filter_hash = $('<div />').html(decodeURI(options.filter_hash)).text();
    window_hash = options.window_hash;
    endless_scroller = options.endless_scroller;
    noajax = options.noajax;
    fsearch = options.search;
    filter_onload = options.filter_onload;
    filer_selected = options.filer_selected;

    if ($.totalStorage != undefined && $.totalStorage('display') != null) {
        $cookie = $.totalStorage;
    } else if ($.cookie != undefined && $.cookie('display') != null) {
        $cookie = $.cookie;
    }

    $("#filterpro_box").on("click", ".option_box .option_name", function (e) {
        $(this).siblings(".collapsible").toggle();
        $(this).toggleClass("hided")
    });
	
    $("#filterpro_box").on("click", ".option_box .attribute_group_name", function (e) {
        $(this).siblings(".attribute_box").toggle();
        $(this).toggleClass("hided")
    });

	$("#filterpro_box").on("click", ".clear_filter", function (e) {
        clear_filter();
        iF(1)
    });

    function clear_filter() {
        $("#filterpro img").removeClass("selected");
        $("#filterpro select").val("");
        $("#filterpro :input").each(function () {
            if ($(this).is(":checked")) {
                $(this).attr("checked", false)
            }
        });
        $("#filterpro .filtered[type=\"radio\"]").each(function (i, e) {
            this.previous = this.checked;
        })
        var b = $("#slider-range").slider("option", "min");
        var a = $("#slider-range").slider("option", "max");
        $("#slider-range").slider("option", {values: [b, a]});
        $("#min_price").val(b);
        $("#max_price").val(a);
        $("div[id^=slider-range-]").each(function (index, element) {
            var id = this.id.replace(/[^\d]/g, '');
            var b = $(element).slider("option", "min");
            var a = $(element).slider("option", "max");
            hs = $(element).slider();
            hs.slider("option", {values: [b, a]});
            hs.slider("option", "slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values: [b, a] });
            $("#attribute_value_" + id + "_min").val('');
            $("#attribute_value_" + id + "_max").val('');
        });
    }

    function setSliders() {
        $("div[id^=slider-range-]").each(function (index, element) {
            var id = this.id.replace(/[^\d]/g, '');
            var arr = window['attr_arr_' + id];

            var b = parseInt($("#attribute_value_" + id + "_min").val());
            var a = parseInt($("#attribute_value_" + id + "_max").val());
            b = arr.indexOf(b);
            a = arr.indexOf(a);
            if (a >= 0 && b >= 0) {
                hs = $(element).slider();
                hs.slider("option", {values: [b, a]});
                hs.slider("option", "slide").call(hs, null, { handle: $(".ui-slider-handle", hs), values: [b, a] });
            }
        });
    }

    $(document).on("click", ".pagination a", (function () {
        var a = $(this).attr("href");
        var url = a.substr(this.baseURI.length - 1);
        var b = a.match(/page[=-](\d+)/) || [, 1];
        $("#filterpro_page").val(b[1]);
        if (noajax) {
            $('#filterpro input[data-name="fp_redirect"]').val(a);
            noAjaxFilter();
        } else {
            doFilter(false, false, false, url);
            var cont = getCont();
            $('html, body').animate({ scrollTop: $(cont).offset().top }, 'slow');
        }
        return false;
    }));

    if ($(".sort select").exists()) {
        $(".sort select").get(0).onchange = null;
        $(".sort select").change(function () {
            var d = $(this).val();
            var a = gUV(d, "sort");
            var b = gUV(d, "order");
            $("#filterpro_sort").val(a);
            $("#filterpro_order").val(b);
            if (noajax) {
                $('#filterpro input[data-name="fp_redirect"]').val(d);
                noAjaxFilter();
            } else {
                iF(0);
            }
        });
    }

    if ($(".limit select").exists()) {
        $(".limit select").get(0).onchange = null;
        $(".limit select").change(function () {
            $("#filterpro_limit").val(gUV($(this).val(), "limit"));
        if (noajax) {
            $("#filterpro_page").val(1);
                $('#filterpro input[data-name="fp_redirect"]').val($(this).val());
            noAjaxFilter();
        } else {
            iF(0);
        }
    });
    }

// deserialize
    var hash = filter_hash? filter_hash : window.location.hash.substr(1);
    history_hash = hash;

    d = parseInt($("#min_price").val());
    c = parseInt($("#max_price").val());
    $("#slider-range").slider("option", {min:d, max:c});

    $("#filterpro").deserialize(hash);

    synchronizeImgCheckboxes();

    $("#filterpro img").bind("click", function() {
        var $input = $(this).prev("input");
        if ($input.attr("disabled")) {
            return;
        }
        $(this).toggleClass("selected");
        $input.prop('checked', !$input.prop('checked'));
        iF(1);
    });

    setSliders();

    if ($(".sort select").exists()) {
        if ($("#filterpro_sort").val()) {
            $(".sort select option").each(function(i, e) {
                if (gUV($(this).val(), "sort") == $("#filterpro_sort").val() && gUV($(this).val(), "order") == $("#filterpro_order").val()) {
                    $(".sort select").val($(this).val());
                    return;
                }
            });
        } else {
            $val = $(".sort select").val();
            $("#filterpro_sort").val(gUV($val, "sort"));
            $("#filterpro_order").val(gUV($val, "order"))
        }
    }
    if ($(".limit select").exists()) {
        if ($("#filterpro_limit").val()) {
		$(".limit select option").each(function(i, e) {
			if (gUV($(this).val(), "limit") == $("#filterpro_limit").val()) {
			    $(this).attr('selected', 'selected');
			    return;
			}
		});
        } else {
            $("#filterpro_limit").val(gUV($(".limit select").val(), "limit"));
        }
    }
    $(".option_name input[type=\"checkbox\"]").click(function(e) {
        e.stopPropagation();
        $(this).parents(".option_box").find('input.filtered').prop('checked', $(this).prop('checked'));
        iF(1);
    });

    d = parseInt($("#min_price").val());
    c = parseInt($("#max_price").val());
    $("#slider-range").slider("option", {values:[d, c]});

    if(noajax || hash || filter_onload)
        doFilter(true, true);

    window.onpopstate = function (e) {
        var hash;
        if(window_hash){
            hash = window.location.hash.substr(1);
        } else {
            var search = window.location.search.substr(1);
            var p = search.match(/page[=-](\d+)/) || [, 1];
            hash = filter_hash.replace(/(page[=-])\d+/, '$1'+p[1])
        }
        if (hash != history_hash) {
            clear_filter();
            $("#filterpro").deserialize(hash);
            d = parseInt($("#min_price").val());
            c = parseInt($("#max_price").val());
            $("#slider-range").slider("option", {values:[d, c]});
            setSliders();

            var old_h = window_hash;
            window_hash = false;
            doFilter(false, false, false);
            history_hash = hash;
            window_hash = old_h;
        }
    }
}
function noAjaxFilter() {
    $('#filterpro input:hidden[data-name]').each(function(i,e){
      $this = $(this);
      $this.attr('name', $this.attr('data-name'));
    });
    $('#filterpro').submit();
    return false;
}

function gUV(e,f){var c=String(e).split("?");var a="";if(c[1]){var b=c[1].split("&");for(var g=0;g<=(b.length);g++){if(b[g]){var d=b[g].split("=");if(d[0]&&d[0]==f){a=d[1]}}}}return a}