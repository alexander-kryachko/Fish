<?php
 class ControllerModulePromotion extends Controller{private $ac2534ce4e9810cc5979f01c765f7e58e=array();public function index(){$this->data=$this->load->language('module/promotion');$this->document->setTitle($this->language->get('heading_title'));$this->load->model('setting/setting');$this->load->model('catalog/promotion');if(($this->request->server['REQUEST_METHOD']=='POST')&&$this->validate()){$a3e5892f562f6e608cb0e3828133c468c['promotion_options']=$this->request->post['promotion_options'];$this->model_setting_setting->editSetting('promotion',$a3e5892f562f6e608cb0e3828133c468c);$this->session->data['success']=$this->language->get('text_success');}if(isset($this->error['warning'])){$this->data['error_warning']=$this->error['warning'];}else{$this->data['error_warning']='';}$this->data['breadcrumbs']=array();$this->data['breadcrumbs'][]=array('text'=>$this->language->get('text_home'),'href'=>$this->url->link('common/home','token='.$this->session->data['token'],'SSL'),'separator'=>false);$this->data['breadcrumbs'][]=array('text'=>$this->language->get('text_module'),'href'=>$this->url->link('extension/module','token='.$this->session->data['token'],'SSL'),'separator'=>' :: ');$this->data['breadcrumbs'][]=array('text'=>$this->language->get('heading_title'),'href'=>$this->url->link('module/promotion','token='.$this->session->data['token'],'SSL'),'separator'=>' :: ');$this->data['action_settings']=$this->url->link('module/promotion','token='.$this->session->data['token'],'SSL');$this->data['cancel']=$this->url->link('extension/module','token='.$this->session->data['token'],'SSL');if(isset($this->request->post['promotion_options'])){$this->data['options']=$this->request->post['promotion_options'];}elseif($this->config->get('promotion_options')){$this->data['options']=$this->config->get('promotion_options');}$this->getList();$this->template='module/promotion.tpl';$this->children=array('common/header','common/footer');$this->response->setOutput($this->render());}protected function getList(){if(isset($this->request->get['page'])){$ac7b0a47278058d499b31d10a76d4726e=(int) $this->request->get['page'];}else{$ac7b0a47278058d499b31d10a76d4726e=1;}$this->data['promotions']=array();$ab836259e92f298fb5a91e8e306810cad=array('start'=>($ac7b0a47278058d499b31d10a76d4726e-1)*$this->config->get('config_admin_limit'),'limit'=>$this->config->get('config_admin_limit'));$a1362a1dc1af45f231e02a10eb89f5c2a=$this->model_catalog_promotion->getPromotions($ab836259e92f298fb5a91e8e306810cad);foreach($a1362a1dc1af45f231e02a10eb89f5c2a as&$a99708c235132effc7ef6ab1e6af9e95c){$a0cf0a79f7fa5817e44390acfff7f6282='';if($a99708c235132effc7ef6ab1e6af9e95c['image']){$a0cf0a79f7fa5817e44390acfff7f6282=$a99708c235132effc7ef6ab1e6af9e95c['image'];}else if($a99708c235132effc7ef6ab1e6af9e95c['gift_image']){$a0cf0a79f7fa5817e44390acfff7f6282=$a99708c235132effc7ef6ab1e6af9e95c['gift_image'];}$a99708c235132effc7ef6ab1e6af9e95c['thumb']=$this->model_catalog_promotion->getThumb($a0cf0a79f7fa5817e44390acfff7f6282);$a99708c235132effc7ef6ab1e6af9e95c['action'][]=array('text'=>$this->language->get('text_edit'),'href'=>$this->url->link('module/promotion/update','token='.$this->session->data['token'].'&promotion_id='.$a99708c235132effc7ef6ab1e6af9e95c['promotion_id'],'SSL'));}unset($a99708c235132effc7ef6ab1e6af9e95c);$this->data['promotions']=$a1362a1dc1af45f231e02a10eb89f5c2a;$aa57068fcb1415c18b7b8317fe13e7c73=new Pagination();$aa57068fcb1415c18b7b8317fe13e7c73->total=$this->model_catalog_promotion->getTotalPromotions();$aa57068fcb1415c18b7b8317fe13e7c73->page=$ac7b0a47278058d499b31d10a76d4726e;$aa57068fcb1415c18b7b8317fe13e7c73->limit=$this->config->get('config_admin_limit');$aa57068fcb1415c18b7b8317fe13e7c73->text=$this->language->get('text_pagination');$aa57068fcb1415c18b7b8317fe13e7c73->url=$this->url->link('module/promotion','token='.$this->session->data['token'].'&page={page}','SSL');$this->data['pagination']=$aa57068fcb1415c18b7b8317fe13e7c73->render();$this->data['insert']=$this->url->link('module/promotion/insert','token='.$this->session->data['token'],'SSL');$this->data['delete']=$this->url->link('module/promotion/delete','token='.$this->session->data['token'],'SSL');}public function insert(){$this->data=$this->load->language('module/promotion');$this->load->model('catalog/promotion');$this->document->setTitle($this->language->get('heading_title'));if(($this->request->server['REQUEST_METHOD']=='POST')&&$this->validateForm()){$this->model_catalog_promotion->addPromotion($this->request->post);$this->session->data['success']=$this->language->get('text_success');$this->redirect($this->url->link('module/promotion','token='.$this->session->data['token'],'SSL'));}$this->getForm();}public function update(){$this->data=$this->load->language('module/promotion');$this->load->model('catalog/promotion');$this->document->setTitle($this->language->get('heading_title'));if(($this->request->server['REQUEST_METHOD']=='POST')&&$this->validateForm()){$this->model_catalog_promotion->editPromotion($this->request->post,$this->request->get['promotion_id']);$this->session->data['success']=$this->language->get('text_success');$this->redirect($this->url->link('module/promotion','token='.$this->session->data['token'],'SSL'));}$this->getForm();}public function delete(){$this->data=$this->load->language('module/promotion');$this->load->model('catalog/promotion');if(isset($this->request->post['selected'])&&$this->validate()){foreach($this->request->post['selected']as $aef90c0c6b840a395c55ae39cf3120b69){$this->model_catalog_promotion->deletePromotion($aef90c0c6b840a395c55ae39cf3120b69);}$this->session->data['success']=$this->language->get('text_success');}$this->redirect($this->url->link('module/promotion','token='.$this->session->data['token'],'SSL'));}protected function getForm(){if(isset($this->error['warning'])){$this->data['error_warning']=$this->error['warning'];}else{$this->data['error_warning']='';}if(isset($this->error['name'])){$this->data['error_name']=$this->error['name'];}else{$this->data['error_name']=array();}if(isset($this->error['image'])){$this->data['error_image']=$this->error['image'];}else{$this->data['error_image']=array();}$this->data['breadcrumbs']=array();$this->data['breadcrumbs'][]=array('text'=>$this->language->get('text_home'),'href'=>$this->url->link('common/home','token='.$this->session->data['token'],'SSL'),'separator'=>false);$this->data['breadcrumbs'][]=array('text'=>$this->language->get('heading_title'),'href'=>$this->url->link('module/promotion','token='.$this->session->data['token'],'SSL'),'separator'=>' :: ');if(!isset($this->request->get['promotion_id'])){$this->data['action']=$this->url->link('module/promotion/insert','token='.$this->session->data['token'],'SSL');}else{$this->data['action']=$this->url->link('module/promotion/update','token='.$this->session->data['token'].'&promotion_id='.$this->request->get['promotion_id'],'SSL');}$this->data['cancel']=$this->url->link('module/promotion','token='.$this->session->data['token'],'SSL');$this->data['token']=$this->session->data['token'];$this->load->model('localisation/language');$this->data['languages']=$this->model_localisation_language->getLanguages();$this->load->model('catalog/product');if(isset($this->request->post['promotion_description'])){$this->data['promotion_description']=$this->request->post['promotion_description'];foreach($this->data['promotion_description']as $a8dc17e1368e9ea1d9f30bb4fd8eb8d6c=>$ab836259e92f298fb5a91e8e306810cad){$a0176129bda26b5201f96dae662c79e05=array();foreach($ab836259e92f298fb5a91e8e306810cad['products']as $a2f068e8c802c070fef35578430eab001){$aa560de11dd7fc7c53993400d4373a6c9=$this->model_catalog_product->getProduct($a2f068e8c802c070fef35578430eab001);if($aa560de11dd7fc7c53993400d4373a6c9){$a0176129bda26b5201f96dae662c79e05[$aa560de11dd7fc7c53993400d4373a6c9['product_id']]=$aa560de11dd7fc7c53993400d4373a6c9['name'];}}$this->data['promotion_description'][$a8dc17e1368e9ea1d9f30bb4fd8eb8d6c]['products']=$a0176129bda26b5201f96dae662c79e05;}}elseif(isset($this->request->get['promotion_id'])){$this->data['promotion_description']=$this->model_catalog_promotion->getPromotionDescriptions($this->request->get['promotion_id']);}else{$this->data['promotion_description']=array();}foreach($this->data['languages']as $a75bf351fc1664ef1e568ba450237edf3){$a0cf0a79f7fa5817e44390acfff7f6282=isset($this->data['promotion_description'][$a75bf351fc1664ef1e568ba450237edf3['language_id']]['image'])?$this->data['promotion_description'][$a75bf351fc1664ef1e568ba450237edf3['language_id']]['image']:'';$this->data['thumb'][$a75bf351fc1664ef1e568ba450237edf3['language_id']]=$this->model_catalog_promotion->getThumb($a0cf0a79f7fa5817e44390acfff7f6282);}$this->data['no_image']=$this->model_catalog_promotion->getThumb('no_image.jpg');$this->template='module/promotion_form.tpl';$this->children=array('common/header','common/footer');$this->response->setOutput($this->render());}public function productsAutocomplete(){$af1c854f304ec3607e2763bf3cbbc7e12=array();if(isset($this->request->get['filter_name'])||isset($this->request->get['filter_model'])||isset($this->request->get['filter_category_id'])){$this->load->model('catalog/promotion');if(isset($this->request->get['filter_name'])){$a55014cce8477196e34b63fcded0b2ae8=$this->request->get['filter_name'];}else{$a55014cce8477196e34b63fcded0b2ae8='';}if(isset($this->request->get['filter_model'])){$a6f5b7d59c5b357b559ca340ee49d75c0=$this->request->get['filter_model'];}else{$a6f5b7d59c5b357b559ca340ee49d75c0='';}if(isset($this->request->get['filter_category_id'])){$a5f2f43e4496c249f0dd0548b672b3ae6=$this->request->get['filter_category_id'];}else{$a5f2f43e4496c249f0dd0548b672b3ae6='';}if(isset($this->request->get['limit'])){$a6594649210bbf38b38e2cc4c9159433f=$this->request->get['limit'];}else{$a6594649210bbf38b38e2cc4c9159433f=2000;}$ab836259e92f298fb5a91e8e306810cad=array('filter_category_id'=>$a5f2f43e4496c249f0dd0548b672b3ae6,'filter_name'=>$a55014cce8477196e34b63fcded0b2ae8,'filter_model'=>$a6f5b7d59c5b357b559ca340ee49d75c0,'start'=>0,'limit'=>$a6594649210bbf38b38e2cc4c9159433f);$aad540057591c32191253925c816aebba=$this->model_catalog_promotion->getProducts($ab836259e92f298fb5a91e8e306810cad);foreach($aad540057591c32191253925c816aebba as $af3c71ace109c95793e97efd1c6903481){$af1c854f304ec3607e2763bf3cbbc7e12[]=array('product_id'=>$af3c71ace109c95793e97efd1c6903481['product_id'],'name'=>strip_tags(html_entity_decode($af3c71ace109c95793e97efd1c6903481['name'],ENT_QUOTES,'UTF-8')),'model'=>$af3c71ace109c95793e97efd1c6903481['model'],'price'=>$af3c71ace109c95793e97efd1c6903481['price']);}}$this->response->setOutput(json_encode($af1c854f304ec3607e2763bf3cbbc7e12));}public function install(){$this->load->model('setting/setting');$this->load->model('catalog/promotion');$this->model_catalog_promotion->install();$this->model_setting_setting->deleteSetting('promotion');$a3e5892f562f6e608cb0e3828133c468c['promotion_options']=$this->model_catalog_promotion->getDefaultOptions();$this->model_setting_setting->editSetting('promotion',$a3e5892f562f6e608cb0e3828133c468c);}public function uninstall(){$this->load->model('setting/setting');$this->load->model('catalog/promotion');$this->model_catalog_promotion->uninstall();$this->model_setting_setting->deleteSetting('promotion');}private function validate(){if(!$this->user->hasPermission('modify','module/promotion')){$this->error['warning']=$this->language->get('error_permission');}return!$this->error?TRUE:FALSE;}protected function validateForm(){if(!$this->user->hasPermission('modify','module/promotion')){$this->error['warning']=$this->language->get('error_permission');}foreach($this->request->post['promotion_description']as $a8dc17e1368e9ea1d9f30bb4fd8eb8d6c=>$a32a2fb1efbbfed446ecf8d7a87d7093e){if((utf8_strlen($a32a2fb1efbbfed446ecf8d7a87d7093e['name'])<2)||(utf8_strlen($a32a2fb1efbbfed446ecf8d7a87d7093e['name'])>255)){$this->error['name'][$a8dc17e1368e9ea1d9f30bb4fd8eb8d6c]=$this->language->get('error_name');}}if($this->error&&!isset($this->error['warning'])){$this->error['warning']=$this->language->get('error_warning');}if(!$this->error){return true;}else{return false;}}}
//author sv2109 (sv2109@gmail.com) license for 1 product copy granted for pinkovskiy (marketing@fisherway.com.ua fisherway.com.ua)
